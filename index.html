<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Offline Kanban</title>

    <style>
      /* ===== Reset & Base ===== */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          sans-serif;
        background: #f4f6f8;
        color: #222;
      }

      h1 {
        margin: 1rem;
      }

      p {
        margin: 0 1rem 1rem;
        color: #555;
      }

      /* ===== Layout ===== */
      main {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 4rem);
      }

      /* ===== Toolbar ===== */
      .toolbar {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem 1rem;
        background: #ffffff;
        border-bottom: 1px solid #ddd;
      }

      .toolbar button,
      .toolbar select,
      .toolbar input {
        font-size: 0.9rem;
      }

      .history-controls,
      .filters,
      .management {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      /* ===== Board ===== */
      .board {
        flex: 1;
        display: grid;
        grid-auto-flow: column;
        grid-auto-columns: minmax(260px, 1fr);
        gap: 1rem;
        padding: 1rem;
        overflow-x: auto;
      }

      /* ===== Columns ===== */
      .column {
        background: #e9ecf1;
        border-radius: 6px;
        padding: 0.5rem;
        display: flex;
        flex-direction: column;
      }

      .column h2 {
        font-size: 1rem;
        margin: 0.25rem 0.5rem 0.5rem;
      }

      /* ===== Cards ===== */
      .card {
        background: #fff;
        border-radius: 6px;
        padding: 0.5rem 0.6rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      .card:focus {
        outline: 2px solid #4c82f7;
      }

      .card-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
      }

      .card-user {
        font-size: 0.75rem;
        color: #555;
      }

      /* ===== Buttons ===== */
      button {
        border: 1px solid #ccc;
        background: #f9f9f9;
        padding: 0.4rem 0.6rem;
        border-radius: 4px;
        cursor: pointer;
      }

      button:hover {
        background: #eee;
      }

      button:focus {
        outline: 2px solid #4c82f7;
      }

      button[value="delete"] {
        background: #ffe5e5;
        border-color: #ffb3b3;
      }

      button[value="delete"]:hover {
        background: #ffcccc;
      }

      /* ===== Dialogs ===== */
      dialog {
        border: none;
        border-radius: 8px;
        padding: 1rem;
        max-width: 400px;
        width: 100%;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      }

      dialog::backdrop {
        background: rgba(0, 0, 0, 0.4);
      }

      dialog h3 {
        margin-top: 0;
      }

      /* ===== Forms ===== */
      form {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      label {
        display: flex;
        flex-direction: column;
        font-size: 0.85rem;
        gap: 0.25rem;
      }

      .color-label {
        display: inline-flex;
        width: fit-content;
      }

      input:not([type="color"]),
      textarea,
      select {
        padding: 0.4rem;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 0.9rem;
      }

      input[type="color"] {
        padding: 0;
        border: none;
        width: 3rem;
        height: 2rem;
        appearance: auto;
        -webkit-appearance: auto;
      }

      textarea {
        resize: vertical;
        min-height: 60px;
      }

      /* ===== Editor Actions ===== */
      .actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .actions > div {
        display: flex;
        gap: 0.5rem;
      }

      .danger {
        margin-left: auto;
      }

      /* ===== Lists in dialogs ===== */
      #userList,
      #columnList {
        list-style: none;
        padding: 0;
        margin: 0 0 0.5rem;
      }

      #userList li,
      #columnList li {
        display: flex;
        justify-content: space-between;
        padding: 0.25rem 0;
        border-bottom: 1px solid #eee;
      }
    </style>
  </head>

  <body>
    <h1>Offline Kanban</h1>
    <p>Use arrow keys to move tasks around</p>

    <main>
      <nav class="toolbar">
        <div class="history-controls">
          <button id="undoBtn">Undo</button>
          <button id="redoBtn">Redo</button>
        </div>

        <div class="filters">
          <label>
            Filter by user
            <select id="filterUser">
              <option value="">-- All --</option>
            </select>
          </label>
        </div>

        <dialog id="userDialog">
          <h3>Manage Users</h3>
          <ul id="userList"></ul>
          <input type="text" id="newUserName" placeholder="New user name" />
          <button id="addUserBtn">Add</button>
          <button id="closeUserDialog">Close</button>
        </dialog>

        <div class="management">
          <button id="manageUsersBtn">Manage Users</button>
          <button id="manageColumnsBtn">Manage Columns</button>
        </div>

        <dialog id="columnDialog">
          <h3>Manage Columns</h3>
          <ul id="columnList"></ul>
          <input type="text" id="newColumnName" placeholder="New column name" />
          <button id="addColumnBtn">Add</button>
          <button id="closeColumnDialog">Close</button>
        </dialog>
      </nav>

      <section class="board" id="board" aria-label="Kanban board"></section>

      <dialog id="editor">
        <form method="dialog">
          <input type="hidden" id="id" />
          <input type="hidden" id="column" />
          <label>Title <input id="title" required /></label>
          <label>Description <textarea id="desc"></textarea></label>
          <label class="color-label">
            Color
            <input type="color" id="cardColor" />
          </label>
          <label>
            Assign to
            <select id="cardUser">
              <option value="">-- None --</option>
            </select>
          </label>

          <div class="actions">
            <div>
              <button value="cancel">Cancel</button>
              <button value="save">Save</button>
            </div>

            <div class="danger">
              <button value="delete">Delete</button>
            </div>
          </div>
        </form>
      </dialog>
    </main>

    <script>
      const DATA = "kanban-data";
      const UNDO = "kanban-undo";
      const REDO = "kanban-redo";
      const USERS_KEY = "kanban-users";
      const COLUMNS_KEY = "kanban-columns";

      const board = document.getElementById("board");
      const editor = document.getElementById("editor");
      const idEl = document.getElementById("id");
      const colEl = document.getElementById("column");
      const titleEl = document.getElementById("title");
      const descEl = document.getElementById("desc");
      const colorEl = document.getElementById("cardColor");
      const filterSelect = document.getElementById("filterUser");
      const undoBtn = document.getElementById("undoBtn");
      const redoBtn = document.getElementById("redoBtn");
      const columnDialog = document.getElementById("columnDialog");
      const columnListEl = document.getElementById("columnList");
      const newColumnInput = document.getElementById("newColumnName");
      const userDialog = document.getElementById("userDialog");
      const userListEl = document.getElementById("userList");
      const newUserInput = document.getElementById("newUserName");
      const manageColumnsBtn = document.getElementById("manageColumnsBtn");
      const closeColumnDialog = document.getElementById("closeColumnDialog");
      const addColumnBtn = document.getElementById("addColumnBtn");
      const addUserBtn = document.getElementById("addUserBtn");
      const manageUsersBtn = document.getElementById("manageUsersBtn");
      const closeUserDialog = document.getElementById("closeUserDialog");
      const userSelect = document.getElementById("cardUser");

      function load(key, fallback = "[]") {
        return JSON.parse(localStorage.getItem(key) || fallback);
      }

      function save(key, data) {
        localStorage.setItem(key, JSON.stringify(data));
      }

      function populateFilterDropdown() {
        const users = load(USERS_KEY);
        filterSelect.innerHTML = '<option value="">-- All --</option>';
        users.forEach((u) => {
          const opt = document.createElement("option");
          opt.value = u.id;
          opt.textContent = u.name;
          filterSelect.appendChild(opt);
        });
      }

      // render functions
      function renderColumns() {
        const columns = load(COLUMNS_KEY);

        board.innerHTML = ""; // clear old columns

        columns.forEach((col) => {
          const colEl = document.createElement("div");
          colEl.className = "column";
          colEl.dataset.column = col;
          colEl.addEventListener("dragover", onDragOver);
          colEl.addEventListener("drop", onDrop);

          const header = document.createElement("h2");
          header.textContent = col;
          colEl.appendChild(header);

          const addBtn = document.createElement("button");
          addBtn.textContent = "Add +";
          addBtn.onclick = () => {
            pushUndo();
            const col = addBtn.parentElement.dataset.column;
            const data = load(DATA);
            const order =
              Math.max(
                0,
                ...data.filter((c) => c.column === col).map((c) => c.order),
              ) + 1;

            const card = {
              id: crypto.randomUUID(),
              column: col,
              order,
              title: "Title",
              description: "",
              color: "#e9ecf1", // default color
              assignedTo: null, // initially unassigned
            };

            data.push(card);
            save(DATA, data);
            render(card.id);
          };
          colEl.appendChild(addBtn);

          const cardsContainer = document.createElement("div");
          cardsContainer.className = "cards";
          colEl.appendChild(cardsContainer);

          board.appendChild(colEl);
        });
      }

      function renderColumnList() {
        const columns = load(COLUMNS_KEY);
        columnListEl.innerHTML = "";
        columns.forEach((col, index) => {
          const li = document.createElement("li");
          li.style.listStyle = "none";
          li.style.marginBottom = "4px";
          li.textContent = col;

          const delBtn = document.createElement("button");
          delBtn.textContent = "❌";
          delBtn.style.marginLeft = "8px";
          delBtn.onclick = () => {
            if (!confirm(`Are you sure you want to delete this column?`))
              return;
            const updated = columns.filter((_, i) => i !== index);
            save(COLUMNS_KEY, updated);
            renderColumnList();

            const data = load(DATA);
            const remainingCards = data.filter((c) => c.column !== col);
            save(DATA, remainingCards);

            clearUndo();
            clearRedo();
            render();
          };

          li.appendChild(delBtn);
          columnListEl.appendChild(li);
        });
      }

      function undo() {
        const undoStack = load(UNDO);
        if (!undoStack.length) return;

        const current = load(DATA);
        const state = undoStack.pop();
        save(DATA, state);

        const redoStack = load(REDO);
        redoStack.push(current);
        save(REDO, redoStack);
        save(UNDO, undoStack);
        render();
      }

      function redo() {
        const redoStack = load(REDO);
        if (!redoStack.length) return;

        const current = load(DATA);
        const state = redoStack.pop();
        save(DATA, state);

        const undoStack = load(UNDO);
        undoStack.push(current);
        save(UNDO, undoStack);

        save(REDO, redoStack);
        render();
      }

      function clearRedo() {
        save(REDO, []);
      }

      function clearUndo() {
        save(UNDO, []);
      }

      function pushUndo() {
        const stack = load(UNDO);
        stack.push(load(DATA));
        save(UNDO, stack.slice(-50));
        clearRedo();
      }

      function render(focusId = null) {
        document.querySelectorAll(".cards").forEach((c) => (c.innerHTML = ""));
        const data = load(DATA);
        renderColumns();

        const filterId = filterSelect.value || null;

        const columns = load(COLUMNS_KEY);
        columns.forEach((col) => {
          const colContainer = document.querySelector(
            `[data-column="${col}"] .cards`,
          );
          if (!colContainer) return;

          data
            .filter((c) => c.column === col)
            .filter((c) => !filterId || c.assignedTo === filterId) // <--- filter by user
            .sort((a, b) => a.order - b.order)
            .forEach((card) => {
              const el = document.createElement("div");
              el.className = "card";
              el.tabIndex = 0;
              el.textContent = card.title;
              el.dataset.id = card.id;
              el.style.backgroundColor = card.color || "#e9ecf1";
              el.draggable = "true";
              el.addEventListener("dragstart", onDragStart);

              if (card.assignedTo) {
                const userLabel = load(USERS_KEY).find(
                  (u) => u.id === card.assignedTo,
                );
                if (userLabel) {
                  const span = document.createElement("span");
                  span.style.fontSize = "0.8em";
                  span.style.marginLeft = "4px";
                  span.style.color = "#555";
                  span.textContent = `(${userLabel.name})`;
                  el.appendChild(span);
                }
              }

              el.ondblclick = () => openEditor(card.id);
              el.onkeydown = (e) => handleKeys(e, card.id);

              colContainer.appendChild(el);
              if (card.id === focusId) el.focus();
            });
        });

        const undoStack = load(UNDO);
        const redoStack = load(REDO);
        undoBtn.disabled = undoStack.length === 0;
        redoBtn.disabled = redoStack.length === 0;
      }

      function openEditor(id) {
        const data = load(DATA);
        const card = data.find((c) => c.id === id);
        if (!card) return;

        idEl.value = card.id;
        colEl.value = card.column;
        titleEl.value = card.title || "Title";
        descEl.value = card.description || "";
        colorEl.value = card.color || "#e9ecf1";

        // Dynamic user dropdown
        const users = load(USERS_KEY);
        userSelect.innerHTML = '<option value="">-- None --</option>';
        users.forEach((u) => {
          const opt = document.createElement("option");
          opt.value = u.id;
          opt.textContent = u.name;
          if (card.assignedTo === u.id) opt.selected = true;
          userSelect.appendChild(opt);
        });

        editor.showModal();
      }

      function renderUserList() {
        const users = load(USERS_KEY);
        userListEl.innerHTML = "";
        users.forEach((u) => {
          const li = document.createElement("li");
          li.style.listStyle = "none";
          li.style.marginBottom = "4px";
          li.textContent = u.name;

          const delBtn = document.createElement("button");
          delBtn.textContent = "❌";
          delBtn.style.marginLeft = "8px";
          delBtn.onclick = () => {
            if (!confirm("Are you sure you want to delete this user?")) return;
            const updated = users.filter((x) => x.id !== u.id);
            save(USERS_KEY, updated);
            renderUserList();
            populateFilterDropdown();
            render();
          };

          li.appendChild(delBtn);
          userListEl.appendChild(li);
        });
      }

      function deleteCard(cardId) {
        if (!confirm("Are you sure you want to delete this card?"))
          return false;
        pushUndo();

        let data = load(DATA);
        data = data.filter((c) => c.id !== cardId);
        save(DATA, data);

        render();
        return true;
      }

      function handleKeys(e, id) {
        const data = load(DATA);
        const card = data.find((c) => c.id === id);
        if (!card) return;

        const sameCol = data
          .filter((c) => c.column === card.column)
          .sort((a, b) => a.order - b.order);

        const idx = sameCol.findIndex((c) => c.id === id);

        if (
          ["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)
        ) {
          e.preventDefault();
          pushUndo();
        }

        if (e.key === "ArrowUp" && idx > 0) {
          swapOrders(card, sameCol[idx - 1], data);
        }

        if (e.key === "ArrowDown" && idx < sameCol.length - 1) {
          swapOrders(card, sameCol[idx + 1], data);
        }

        if (e.key === "ArrowLeft") moveColumn(card, -1, data);
        if (e.key === "ArrowRight") moveColumn(card, 1, data);
        if (e.key === "Enter") openEditor(id);
      }

      function swapOrders(a, b, data) {
        [a.order, b.order] = [b.order, a.order];
        save(DATA, data);
        render(a.id);
      }

      function moveColumn(card, dir, data) {
        const cols = load(COLUMNS_KEY);
        const newIndex = cols.indexOf(card.column) + dir;
        if (newIndex < 0 || newIndex >= cols.length) return;

        card.column = cols[newIndex];
        card.order =
          Math.max(
            0,
            ...data.filter((c) => c.column === card.column).map((c) => c.order),
          ) + 1;

        save(DATA, data);
        render(card.id);
      }

      let draggedCardId = null;

      function onDragStart(e) {
        draggedCardId = e.target.dataset.id;
        e.dataTransfer.effectAllowed = "move";
      }

      function onDragOver(e) {
        e.preventDefault(); // required to allow drop
        e.dataTransfer.dropEffect = "move";
      }

      function onDrop(e) {
        e.preventDefault();

        const targetColumn = e.currentTarget.dataset.column;
        const data = load(DATA);

        const card = data.find((c) => c.id === draggedCardId);
        if (!card || card.column === targetColumn) return;

        pushUndo();

        card.column = targetColumn;

        card.order =
          Math.max(
            -1,
            ...data
              .filter((c) => c.column === targetColumn)
              .map((c) => c.order),
          ) + 1;

        save(DATA, data);
        render(card.id);

        draggedCardId = null;
      }

      function deleteFocusedCard() {
        const focused = document.activeElement; // current focus
        if (!focused || !focused.classList.contains("card")) return; // only delete cards
        const cardId = focused.dataset.id;
        if (!cardId) return;

        deleteCard(cardId);
      }

      function addUser() {
        const name = newUserInput.value.trim();
        if (!name) return;
        const users = load(USERS_KEY);
        const id = crypto.randomUUID();
        users.push({ id, name });
        save(USERS_KEY, users);
        newUserInput.value = "";
        renderUserList();
        render();
      }

      function editCard(data, c) {
        pushUndo();

        c.title = titleEl.value || "";
        c.description = descEl.value || "";
        c.color = colorEl.value || "#e9ecf1";
        c.assignedTo = userSelect.value || null;

        const updateIndex = data.findIndex((card) => card.id === c.id);
        data[updateIndex] = c;

        save(DATA, data);
        render(c.id);
      }

      function handleEditorClose() {
        if (editor.returnValue === "cancel") return;

        let data = load(DATA);
        const c = data.find((x) => x.id === idEl.value);
        if (!c) return;

        if (editor.returnValue === "delete") {
          if (!deleteCard(c.id)) {
            editor.showModal();
          }
          return;
        }

        editCard(data, c);
      }

      function addColumn() {
        const name = newColumnInput.value.trim();
        if (!name) return;
        const columns = load(COLUMNS_KEY);
        columns.push(name);
        save(COLUMNS_KEY, columns);
        newColumnInput.value = "";
        renderColumnList();
        render();
      }

      // listeners
      filterSelect.onchange = () => render();

      manageUsersBtn.onclick = () => {
        renderUserList();
        userDialog.showModal();
      };
      addUserBtn.onclick = () => {
        addUser();
        populateFilterDropdown();
      };

      closeUserDialog.onclick = () => userDialog.close();

      editor.addEventListener("close", () => handleEditorClose());

      undoBtn.onclick = () => undo();
      redoBtn.onclick = () => redo();

      addColumnBtn.onclick = () => addColumn();

      manageColumnsBtn.onclick = () => {
        renderColumnList();
        columnDialog.showModal();
      };

      closeColumnDialog.onclick = () => columnDialog.close();

      document.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && !e.shiftKey && e.key === "z") {
          e.preventDefault();
          undo();
        }

        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === "z") {
          e.preventDefault();
          redo();
        }
        if (e.key === "Delete") {
          e.preventDefault();
          deleteFocusedCard();
        }
      });

      populateFilterDropdown();
      render();
    </script>
  </body>
</html>
